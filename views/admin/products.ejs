<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>
<style>
    table {
        font-size: 0.875rem;
        /* Smaller text */
    }

    th,
    td {
        padding: 6px 10px;
        /* Reduced padding */
        white-space: nowrap;
        /* Prevent text wrapping */
    }

    td button {
        padding: 4px 8px;
        /* Smaller buttons */
        font-size: 0.75rem;
        /* Smaller button text */
    }

    .overflow-x-auto {
        max-height: 500px;
        /* Limit table height */
    }
</style>

<body class="bg-gray-900 text-gray-300">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <%- include("../partials/admin/header") %>
            <!-- Main Content -->
            <div class="flex-1 p-6">
                <form action="/admin/products" method="get">
                    <div class="flex justify-between items-center mb-6">
                        <input class="bg-gray-800 text-gray-400 p-2 rounded w-1/3" placeholder="Search for Products"
                            type="text" />
                        <button class="bg-green-500 text-white px-4 py-2 rounded">
                            <a href="addProducts">ADD PRODUCT +</a>
                        </button>
                    </div>
                </form>
                <div class="bg-gray-800 p-4 rounded">
                    <h2 class="text-xl font-bold mb-4">Products</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-gray-400">
                                    <th class="py-2"></th>
                                    <th class="py-2">PRODUCT NAME</th>
                                    <th class="py-2">PRODUCT CATEGORY</th>
                                    <th class="py-2">SALES PRICE</th>
                                    <th class="py-2">OFFER PRICE</th>
                                    <th class="py-2">OFFER</th>
                                    <th class="py-2">QUANTITY</th>
                                    <th class="py-2">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (data && data.length> 0) { %>
                                    <% data.forEach(function(item) { %>
                                        <tr class="border-b border-gray-700">
                                            <td class="py-2"></td>
                                            <td class="py-2">
                                                <%= item.productName %>
                                            </td>
                                            <td class="py-2">
                                                <%= item.category ? item.category.name : 'Unknown' %>
                                            </td>
                                            <td class="py-2">
                                                <%= item.regularPrice %>
                                            </td>
                                            <td class="py-2">
                                                <%= item.salePrice %>
                                            </td>
                                            <td class="py-2">
                                                <% if (item.productOffer && item.productOffer> 0) { %>
                                                    <button type="button"
                                                        class="offer-button bg-red-500 text-white px-2 py-1 rounded"
                                                        data-product-id="<%= item._id %>" data-has-offer="true"
                                                        onclick="removeOffer('<%= item._id %>')">
                                                        Remove
                                                    </button>
                                                    <% } else { %>
                                                        <button type="button"
                                                            class="offer-button bg-blue-500 text-white px-2 py-1 rounded"
                                                            data-product-id="<%= item._id %>" data-has-offer="false"
                                                            onclick="addOffer('<%= item._id %>')">
                                                            Add Offer
                                                        </button>
                                                        <% } %>
                                            </td>
                                            <td class="py-2">
                                                <%= item.quantity %>
                                            </td>
                                            <td class="py-2 flex space-x-2">
                                                <button
                                                    class="<%= item.status === 'Blocked' ? 'bg-green-500' : 'bg-red-500' %> text-white px-2 py-1 rounded"
                                                    onclick="toggleBlock(this, '<%= item._id %>', '<%= item.status %>')"
                                                    data-status="<%= item.status %>">
                                                    <%= item.status==='Blocked' ? 'Unblock' : 'Block' %>
                                                </button>
                                                <a href="/admin/editProduct/<%=item._id%>"> <i class="fas fa-edit text-gray-400 hover:text-white cursor-pointer"></i></a>
                                            </td>
                                        </tr>
                                        <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="8" class="py-4 text-center">No products found</td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-gray-400">SHOWING 1 OF 10</span>
                        <div class="flex space-x-2">
                            <button class="px-2 py-1 bg-gray-700 text-gray-400 rounded">1</button>
                            <button class="px-2 py-1 bg-gray-700 text-gray-400 rounded">2</button>
                            <button class="px-2 py-1 bg-purple-500 text-white rounded">3</button>
                            <button class="px-2 py-1 bg-gray-700 text-gray-400 rounded">4</button>
                            <button class="px-2 py-1 bg-gray-700 text-gray-400 rounded">...</button>
                            <button class="px-2 py-1 bg-gray-700 text-gray-400 rounded">9</button>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</body>

</html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function toggleBlock(button) {
        if (button.innerText === "Block") {
            button.innerText = "Unblock";
            button.classList.remove("bg-red-500");
            button.classList.add("bg-green-500");
        } else {
            button.innerText = "Block";
            button.classList.remove("bg-green-500");
            button.classList.add("bg-red-500");
        }
    }

    function toggleOffer(button) {
        const productId = button.getAttribute('data-product-id');
        const hasOffer = button.getAttribute('data-has-offer') === 'true';

        console.log('Product ID:', productId, 'Has Offer:', hasOffer);

        if (!hasOffer) {
            addOffer(productId);
        } else {
            
            removeOffer(productId);
        }
    }

    function addOffer(productId) {
        Swal.fire({
            title: 'Offer in percentage',
            input: 'number',
            inputLabel: 'Percentage',
            inputPlaceholder: '%',
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value || value <= 0 || value > 100) {
                    return 'Please enter a valid percentage (1-100)';
                }
            }
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/admin/addProductOffer',
                    method: 'POST',
                    data: {
                        percentage: result.value,
                        productId: productId
                    },
                    success: (response) => {
                        if (response.status === true) {
                            Swal.fire('Success', 'The offer has been added successfully.', 'success')
                                .then(() => {
                                   
                                    window.location.reload(true);
                                });
                        } else {
                            Swal.fire('Failed', response.message || 'Failed to add offer.', 'error');
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('AJAX error:', xhr.responseText, status, error);
                        Swal.fire('Error', 'An error occurred. Please try again.', 'error');
                    }
                });
            }
        });
    }
    function removeOffer(productId) {
        Swal.fire({
            title: 'Remove Offer',
            text: 'Are you sure you want to remove this offer?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/removeProductOffer',
                    method: 'POST',
                    data: {
                        productId: productId
                    },
                    success: (response) => {
                        console.log('Remove offer response:', response);
                        if (response.status === true) {
                            Swal.fire('Removed!', 'The offer has been removed', 'success')
                                .then(() => {
                                   
                                    window.location.reload();
                                });
                        } else {
                            Swal.fire('Failed', response.message || 'Failed to remove offer', 'error');
                        }
                    },
                    error: (xhr, status, error) => {
                        console.error('AJAX error:', xhr.responseText, status, error);
                        Swal.fire('Error', 'An error occurred. Please try again.', 'error');
                    }
                });
            }
        });
    }

    function toggleBlock(button, productId) {
    const currentStatus = button.getAttribute('data-status');
    const newStatus = currentStatus === 'Blocked' ? 'Available' : 'Blocked';

    $.ajax({
        url: '/admin/toggleProductStatus',
        method: 'POST',
        data: {
            productId: productId,
            status: newStatus
        },
        success: (response) => {
            if (response.status === true) {
              
                button.innerText = newStatus === 'Blocked' ? 'Unblock' : 'Block';
                button.setAttribute('data-status', newStatus);  // âœ… Correctly updating the attribute

                if (newStatus === 'Blocked') {
                    button.classList.remove("bg-red-500");
                    button.classList.add("bg-green-500");
                } else {
                    button.classList.remove("bg-green-500");
                    button.classList.add("bg-red-500");
                }

                Swal.fire('Success', `Product ${newStatus === 'Blocked' ? 'blocked' : 'unblocked'} successfully`, 'success');
            } else {
                Swal.fire('Failed', response.message || 'Failed to update product status', 'error');
            }
        },
        error: (xhr, status, error) => {
            console.error('AJAX error:', xhr.responseText, status, error);
            Swal.fire('Error', 'An error occurred. Please try again.', 'error');
        }
    });
}

</script>