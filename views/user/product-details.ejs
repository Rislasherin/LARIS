<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title><%= product.name %> - Product Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    .zoom-image {
      transition: transform 0.3s;
    }
    .zoom-image:hover {
      transform: scale(1.1);
    }
    .star-rating {
      cursor: pointer;
    }
    .tab-content {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      background-color: #EF4444;
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
    }

.product-image-container {
  position: relative;
  overflow: hidden;
}

.zoom-image {
  transition: transform 0.3s ease;
  cursor: crosshair;
}

.magnifier {
  position: absolute;
  border: 2px solid #fbbf24;
  border-radius: 50%;
  pointer-events: none;
  z-index: 10;
}

.zoomed-image-container {
  position: absolute;
  overflow: hidden;
  background-color: white;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  z-index: 100;
}

.zoomed-image {
  position: absolute;
}


@media (max-width: 768px) {
  .zoomed-image-container {
    left: 0 !important;
    top: 100% !important;
    width: 100% !important;
    margin-top: 15px;
    margin-left: 0 !important;
    height: 250px !important;
  }
}
.product-card {
  min-height: 400px; 
  display: flex;
  flex-direction: column;
}

.product-card .content {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease-out;
  }
  .notification.success {
    background-color: #10B981;
    color: white;
  }
  .notification.error {
    background-color: #EF4444;
    color: white;
  }
  </style>
</head>
<body class="bg-white text-gray-800">
  <%- include('../partials/user/header') %>

  <main class="container mx-auto py-8 px-6">

    <nav class="flex mb-6 text-sm">
      <ol class="flex items-center space-x-2">
        <li><a href="/" class="text-gray-500 hover:text-gray-700">Home</a></li>
        <li><span class="text-gray-500">/</span></li>
        <li><a  class="text-gray-500 hover:text-gray-700"><%= product.category %></a></li>
        <li><span class="text-gray-500">/</span></li>
        <li class="text-gray-800 font-medium"><%= product.name %></li>
      </ol>
    </nav>

    <div class="flex flex-col lg:flex-row">

      <div class="lg:w-1/2 flex flex-col items-center relative">
        <% if (product.originalPrice) { %>
        <% } %>
        <div class="relative">
          <div class="w-80 h-80 overflow-hidden flex items-center justify-center">
            <img id="mainImage" alt="Product image of <%= product.name %>" class="zoom-image" height="500" src="<%= product.image %>" width="375" />
          </div>
          <div class="absolute top-2 right-2 bg-white rounded-full p-2 cursor-pointer shadow-md" onclick="toggleWishlist('<%= product._id %>')">
            <i id="wishlistIcon" class="far fa-heart text-red-500"></i>
          </div>
        </div>
        

        <div class="flex justify-center mt-4 space-x-4">
          <img alt="Main product image" class="w-16 h-16 cursor-pointer border-2 border-yellow-500" height="64" src="<%= product.image %>" width="64" onclick="changeImage('<%= product.image %>')" />
          <% product.additionalImages.forEach((img, index) => { %>
            <img alt="Additional product image <%= index + 1 %>" class="w-16 h-16 cursor-pointer border-2 border-transparent hover:border-yellow-500" height="64" src="<%= img %>" width="64" onclick="changeImage('<%= img %>')" />
          <% }) %>
        </div>
      </div>


      <div class="lg:w-1/2 lg:pl-10 mt-8 lg:mt-0">
        <div class="flex flex-wrap items-center">
          <div class="text-sm text-gray-500 mr-4"><%= product.category %></div>
          <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">In Stock</div>
        </div>
        <h1 class="text-3xl font-bold mt-2"><%= product.name %></h1>
        <div class="flex items-center mt-2">
          <div class="text-yellow-500">
            <% for(let i = 0; i < 5; i++) { %>
              <% if (i < Math.floor(product.rating)) { %>
                <i class="fas fa-star"></i>
              <% } else if (i === Math.floor(product.rating) && product.rating % 1 !== 0) { %>
                <i class="fas fa-star-half-alt"></i>
              <% } else { %>
                <i class="far fa-star"></i>
              <% } %>
            <% } %>
          </div>
          <span class="ml-2 text-gray-500">(<%= product.reviewCount %> reviews)</span>
        </div>
        <div class="text-xl text-red-500 mt-2">
          <%= product.price %>
          <% if (product.originalPrice) { %>
            <span class="line-through text-gray-500 ml-2"><%= product.originalPrice %></span>
            <span class="ml-2 text-green-500">(<%= product.offerPercentage !== null ? product.offerPercentage : 0 %>% OFF)</span>
          <% } %>
        </div>
        <!-- <div class="mt-4">
          <span class="font-semibold">Brand:</span> 
          <a href="/brand/<%= product.brand.toLowerCase().replace(' ', '-') %>" class="text-blue-600 hover:underline"><%= product.brand %></a>
        </div> -->
        <div class="mt-4">
          <!-- <h3 class="font-semibold text-lg">Key Features:</h3>
          <ul class="list-disc list-inside mt-2 space-y-2 text-gray-700">
            <% product.features.forEach(feature => { %>
              <li><%= feature %></li>
            <% }) %>
          </ul> -->
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <div>
            <span class="font-semibold">Skin Type:</span> 
            <div class="mt-1">
              <% if (product.skinType.length > 0 && product.skinType[0]) { %>
                <% product.skinType.forEach(type => { %>
                  <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded mr-1 mb-1"><%= type %></span>
                <% }) %>
              <% } else { %>
                <span class="text-gray-500">Not specified</span>
              <% } %>
            </div>
          </div>
          <div>
            <span class="font-semibold">Skin Concerns:</span>
            <div class="mt-1">
              <% if (product.skinConcerns.length > 0 && product.skinConcerns[0]) { %>
                <% product.skinConcerns.forEach(concern => { %>
                  <span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded mr-1 mb-1"><%= concern %></span>
                <% }) %>
              <% } else { %>
                <span class="text-gray-500">Not specified</span>
              <% } %>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <span class="font-semibold">Size:</span>
          <div class="flex space-x-2 mt-2">
            <% product.variants.forEach((variant, index) => { %>
              <button 
                class="size-btn bg-white border border-gray-300 px-3 py-1 rounded hover:border-gray-800 <%= variant.quantity > 0 ? '' : 'opacity-50 cursor-not-allowed' %>" 
                data-variant-index="<%= index %>"
                <%= variant.quantity === 0 ? 'disabled' : '' %>
              >
                <%= variant.size %> <%= variant.quantity > 0 ? `(${variant.quantity} in stock)` : '(Out of stock)' %>
              </button>
            <% }) %>
          </div>
          <div id="size-error" class="text-red-500 text-sm mt-1 hidden">Please select a size</div>
        </div>
        
        <form id="cartForm" class="mt-6">
          <input type="hidden" name="productId" value="<%= product._id %>" />
          <input type="hidden" name="variantIndex" id="variantIndex" value="" />
          <div class="flex items-center space-x-4">
            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
              <div class="flex items-center mt-1">
                <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-l" onclick="decrementQuantity()">-</button>
                <input id="quantity" name="quantity" class="border border-gray-300 text-center w-12 py-1" type="number" value="1" min="1" />
                <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-r" onclick="incrementQuantity()">+</button>
              </div>
            </div>
            <div class="flex-1 flex space-x-2">
              <button 
                type="submit" 
                class="flex-1 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition-colors flex items-center justify-center"
              >
                <i class="fas fa-shopping-cart mr-2"></i> ADD TO CART
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

        

        <div class="mt-6 border-t pt-4">
          <div class="flex items-center space-x-2 mb-2">
            <i class="fas fa-truck text-gray-600"></i>
            <span>Free shipping on orders over 50</span>
          </div>
          <div class="flex items-center space-x-2 mb-2">
            <i class="fas fa-undo text-gray-600"></i>
            <span>30-day return policy</span>
          </div>
          <div class="flex items-center space-x-2">
            <i class="fas fa-shield-alt text-gray-600"></i>
            <span>100% Authentic Products</span>
          </div>
        </div>
        

        <div class="mt-4 flex items-center space-x-4">
          <span class="text-gray-700">Share:</span>
          <a href="#" class="text-blue-600"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="text-blue-400"><i class="fab fa-twitter"></i></a>
          <a href="#" class="text-pink-600"><i class="fab fa-instagram"></i></a>
          <a href="#" class="text-red-600"><i class="fab fa-pinterest"></i></a>
        </div>
      </div>
    </div>


    <div class="mt-10">
      <div class="border-b">
        <ul class="flex space-x-4">
          <li id="descTab" class="py-2 border-b-2 border-gray-800 cursor-pointer" onclick="showTab('description')">Description</li>
          <li id="howToTab" class="py-2 text-gray-500 cursor-pointer" onclick="showTab('howToUse')">How To Use</li>
          <li id="revTab" class="py-2 text-gray-500 cursor-pointer" onclick="showTab('reviews')">Reviews (<%= product.reviewCount %>)</li>
        </ul>
      </div>
      
      <div id="description" class="tab-content mt-4">
        <div class="prose max-w-none">
          <p><%= product.description %></p>
        </div>
      </div>
    
      <!-- Add the How To Use section here -->
      <div id="howToUse" class="tab-content mt-4 hidden">
        <div class="prose max-w-none">
          <% if (product.howToUse) { %>
            <p><%= product.howToUse %></p>
          <% } else { %>
            <p>No usage instructions available.</p>
          <% } %>
        </div>
      </div>
    
      <div id="reviews" class="tab-content mt-4 hidden">

        <div class="flex flex-col md:flex-row mb-6">
          <div class="md:w-1/3 mb-4 md:mb-0">
            <div class="text-center">
              <div class="text-5xl font-bold text-gray-800"><%= product.rating.toFixed(1) %></div>
              <div class="text-yellow-500 text-xl flex justify-center mt-2">
                <% for(let i = 0; i < 5; i++) { %>
                  <% if (i < Math.floor(product.rating)) { %>
                    <i class="fas fa-star"></i>
                  <% } else if (i === Math.floor(product.rating) && product.rating % 1 !== 0) { %>
                    <i class="fas fa-star-half-alt"></i>
                  <% } else { %>
                    <i class="far fa-star"></i>
                  <% } %>
                <% } %>
              </div>
              <div class="text-gray-600 mt-1">Based on <%= product.reviewCount %> reviews</div>
            </div>
          </div>
          <div class="md:w-2/3 md:pl-6">
            <div class="space-y-2">
              <div class="flex items-center">
                <div class="w-24">5 stars</div>
                <div class="flex-1 bg-gray-200 h-4 rounded overflow-hidden">
                  <div class="bg-yellow-500 h-full" style="width: 75%"></div>
                </div>
                <div class="w-16 text-right">75%</div>
              </div>
              <div class="flex items-center">
                <div class="w-24">4 stars</div>
                <div class="flex-1 bg-gray-200 h-4 rounded overflow-hidden">
                  <div class="bg-yellow-500 h-full" style="width: 15%"></div>
                </div>
                <div class="w-16 text-right">15%</div>
              </div>
              <div class="flex items-center">
                <div class="w-24">3 stars</div>
                <div class="flex-1 bg-gray-200 h-4 rounded overflow-hidden">
                  <div class="bg-yellow-500 h-full" style="width: 5%"></div>
                </div>
                <div class="w-16 text-right">5%</div>
              </div>
              <div class="flex items-center">
                <div class="w-24">2 stars</div>
                <div class="flex-1 bg-gray-200 h-4 rounded overflow-hidden">
                  <div class="bg-yellow-500 h-full" style="width: 3%"></div>
                </div>
                <div class="w-16 text-right">3%</div>
              </div>
              <div class="flex items-center">
                <div class="w-24">1 star</div>
                <div class="flex-1 bg-gray-200 h-4 rounded overflow-hidden">
                  <div class="bg-yellow-500 h-full" style="width: 2%"></div>
                </div>
                <div class="w-16 text-right">2%</div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row sm:justify-between items-start sm:items-center mb-6 pb-4 border-b">
          <div class="flex space-x-2 mb-3 sm:mb-0">
            <button class="px-3 py-1 bg-gray-800 text-white rounded">All Reviews</button>
            <button class="px-3 py-1 bg-white border border-gray-300 rounded">5 Star</button>
            <button class="px-3 py-1 bg-white border border-gray-300 rounded">With Photos</button>
          </div>
          <div class="flex items-center">
            <label for="sortReviews" class="mr-2">Sort by:</label>
            <select id="sortReviews" class="border rounded px-2 py-1">
              <option value="newest">Newest</option>
              <option value="highest">Highest Rated</option>
              <option value="lowest">Lowest Rated</option>
            </select>
          </div>
        </div>

        <div class="space-y-6">

          <div class="border-b pb-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span class="text-xl font-bold text-gray-600">JD</span>
                </div>
                <div>
                  <div class="font-semibold">Jane Doe</div>
                  <div class="text-sm text-gray-500">Verified Purchaser</div>
                </div>
              </div>
              <div class="text-sm text-gray-500">March 15, 2025</div>
            </div>
            <div class="flex space-x-1 text-yellow-500 mb-2">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
            </div>
            <h4 class="font-semibold mb-2">Amazing product for combination skin!</h4>
            <p class="mb-3">This product is amazing! I've been using it for a month and have seen significant improvements in my skin texture. My T-zone is much less oily, and the dry patches on my cheeks have disappeared. Highly recommended for anyone with combination skin.</p>
            <div class="flex space-x-3 mb-3">
              <img src="/images/review1-photo1.jpg" alt="Review photo" class="w-16 h-16 object-cover rounded" onerror="this.src='/api/placeholder/100/100'; this.onerror=null;">
              <img src="/images/review1-photo2.jpg" alt="Review photo" class="w-16 h-16 object-cover rounded" onerror="this.src='/api/placeholder/100/100'; this.onerror=null;">
            </div>
            <div class="flex items-center text-sm text-gray-600">
              <button class="flex items-center mr-4">
                <i class="far fa-thumbs-up mr-1"></i> Helpful (12)
              </button>
              <button class="flex items-center">
                <i class="far fa-comment mr-1"></i> Comment
              </button>
            </div>
          </div>

          <div class="border-b pb-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span class="text-xl font-bold text-gray-600">JS</span>
                </div>
                <div>
                  <div class="font-semibold">John Smith</div>
                  <div class="text-sm text-gray-500">Verified Purchaser</div>
                </div>
              </div>
              <div class="text-sm text-gray-500">March 10, 2025</div>
            </div>
            <div class="flex space-x-1 text-yellow-500 mb-2">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="far fa-star"></i>
            </div>
            <h4 class="font-semibold mb-2">Great results but strong scent</h4>
            <p class="mb-3">Great product overall. The scent is a bit strong for my liking, but the results are worth it. I've noticed my skin looks more radiant after just two weeks of consistent use. Would recommend, but be aware of the fragrance if you're sensitive.</p>
            <div class="flex items-center text-sm text-gray-600">
              <button class="flex items-center mr-4">
                <i class="far fa-thumbs-up mr-1"></i> Helpful (8)
              </button>
              <button class="flex items-center">
                <i class="far fa-comment mr-1"></i> Comment
              </button>
            </div>
          </div>

          <div class="border-b pb-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                  <span class="text-xl font-bold text-gray-600">EJ</span>
                </div>
                <div>
                  <div class="font-semibold">Emily Johnson</div>
                  <div class="text-sm text-gray-500">Verified Purchaser</div>
                </div>
              </div>
              <div class="text-sm text-gray-500">March 5, 2025</div>
            </div>
            <div class="flex space-x-1 text-yellow-500 mb-2">
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star"></i>
              <i class="fas fa-star-half-alt"></i>
              <i class="far fa-star"></i>
            </div>
            <h4 class="font-semibold mb-2">Perfect for sensitive skin</h4>
              <p class="mb-3">I have sensitive skin and was hesitant to try this, but it worked wonderfully. No irritation and my skin feels hydrated all day. The packaging could be improved though - the pump sometimes gets stuck and makes it difficult to dispense the product.</p>
            <div class="flex items-center text-sm text-gray-600">
              <button class="flex items-center mr-4">
                <i class="far fa-thumbs-up mr-1"></i> Helpful (5)
              </button>
              <button class="flex items-center">
                <i class="far fa-comment mr-1"></i> Comment
              </button>
            </div>
          </div>
        </div>

        <div class="flex justify-center mt-6">
          <nav class="inline-flex rounded-md shadow">
            <a href="#" class="py-2 px-4 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">Previous</a>
            <a href="#" class="py-2 px-4 bg-gray-800 text-white border border-gray-800">1</a>
            <a href="#" class="py-2 px-4 bg-white border border-gray-300 hover:bg-gray-50">2</a>
            <a href="#" class="py-2 px-4 bg-white border border-gray-300 hover:bg-gray-50">3</a>
            <a href="#" class="py-2 px-4 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">Next</a>
          </nav>
        </div>
        

        <div class="mt-8 border-t pt-6">
          <h3 class="text-xl font-bold mb-4">Write a Review</h3>
          <form id="reviewForm" method="POST" action="/product/<%= product._id %>/review">
            <p class="mb-4 text-sm text-gray-600">Your email address will not be published. Required fields are marked *</p>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2" for="rating">Your rating *</label>
              <div class="flex space-x-1 text-yellow-500 text-2xl">
                <i class="far fa-star cursor-pointer star-rating" data-rating="1"></i>
                <i class="far fa-star cursor-pointer star-rating" data-rating="2"></i>
                <i class="far fa-star cursor-pointer star-rating" data-rating="3"></i>
                <i class="far fa-star cursor-pointer star-rating" data-rating="4"></i>
                <i class="far fa-star cursor-pointer star-rating" data-rating="5"></i>
              </div>
              <input type="hidden" name="rating" id="rating" value="0">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2" for="reviewTitle">Review Title *</label>
              <input name="title" class="w-full border rounded px-3 py-2" id="reviewTitle" type="text" required />
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2" for="review">Your review *</label>
              <textarea name="text" class="w-full border rounded px-3 py-2" id="review" rows="4" required></textarea>
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 mb-2">Add Photos</label>
              <div class="flex items-center">
                <label class="cursor-pointer flex items-center justify-center w-20 h-20 border-2 border-dashed border-gray-300 rounded">
                  <input type="file" name="photos" accept="image/*" class="hidden" multiple />
                  <i class="fas fa-camera text-gray-400 text-xl"></i>
                </label>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-gray-700 mb-2" for="name">Name *</label>
                <input name="name" class="w-full border rounded px-3 py-2" id="name" type="text" required />
              </div>
              <div>
                <label class="block text-gray-700 mb-2" for="email">Email *</label>
                <input name="email" class="w-full border rounded px-3 py-2" id="email" type="email" required />
              </div>
            </div>
            <div class="mb-4">
              <label class="flex items-center">
                <input type="checkbox" name="saveInfo" class="mr-2" />
                <span class="text-sm text-gray-700">Save my name and email for the next time I comment</span>
              </label>
            </div>
            <button type="submit" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-700 transition-colors">SUBMIT REVIEW</button>
          </form>
        </div>
      </div>
    </div>
    <div class="mt-12">
      <h2 class="text-2xl font-bold mb-4">You May Also Like</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <% relatedProducts.forEach(related => { %>
          <a href="/product/<%= related._id %>" class="group block">
            <div class="border p-4 rounded-lg hover:shadow-lg transition-shadow product-card flex flex-col">
              <div class="relative overflow-hidden h-48">
                <img 
                  alt="Product image of <%= related.name %>" 
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" 
                  src="<%= related.image %>" 
                />
                <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                  <button class="bg-white text-gray-800 px-4 py-2 rounded-full hover:bg-yellow-500 hover:text-white transition-colors">
                    Quick View
                  </button>
                </div>
              </div>
    
              <!-- Content with Consistent Spacing -->
              <div class="mt-2 content flex flex-col">
                <div class="text-sm text-gray-500"><%= related.category %></div>
                <div class="mt-1 font-medium text-gray-800 group-hover:text-yellow-500 transition-colors line-clamp-2 h-12">
                  <%= related.name %>
                </div>
                <div class="mt-1 text-red-500 flex items-center">
                  <%= related.price %>
                  <% if (related.originalPrice) { %>
                    <span class="line-through text-gray-400 ml-1 text-sm"><%= related.originalPrice %></span>
                  <% } %>
                </div>
                <div class="flex items-center mt-1 text-sm text-yellow-500">
                  <% for(let i = 0; i < 5; i++) { %>
                    <% if (i < Math.floor(related.rating)) { %>
                      <i class="fas fa-star"></i>
                    <% } else if (i === Math.floor(related.rating) && related.rating % 1 !== 0) { %>
                      <i class="fas fa-star-half-alt"></i>
                    <% } else { %>
                      <i class="far fa-star"></i>
                    <% } %>
                  <% } %>
                  <span class="ml-1 text-gray-500">(<%= related.reviewCount %>)</span>
                </div>
              </div>
            </div>
          </a>
        <% }) %>
      </div>
    </div>


  <!-- <h2 class="text-2xl font-bold mb-4">
    <% if (recentlyViewedProducts && recentlyViewedProducts.length > 0) { %>
      Recently Viewed
    <% } else { %>
      More Products You Might Like
    <% } %>
  </h2> -->
  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
    <% if (recentlyViewedProducts && recentlyViewedProducts.length > 0) { %>
      <% recentlyViewedProducts.forEach(item => { %>
   
      <% }); %>
    <% } else { %>
      <% relatedProducts.slice(0, 6).forEach(item => { %>
        <a href="/product/<%= item._id %>" class="border p-2 rounded hover:shadow-md transition-shadow">
          <img alt="<%= item.name %>" class="w-full h-32 object-cover" src="<%= item.image %>" />
          <div class="mt-2 text-sm font-medium truncate"><%= item.name %></div>
          <div class="text-red-500 text-sm"><%= item.price %></div>
        </a>
      <% }); %>
    <% } %>
  </div>
</div>
  </main>

  <%- include('../partials/user/footer') %>


  <script>

    function changeImage(src) {
      const mainImage = document.getElementById("mainImage");
      mainImage.src = src;
      

      const thumbnails = document.querySelectorAll(".flex.justify-center.mt-4.space-x-4 img");
      thumbnails.forEach(thumb => {
        if (thumb.src === src) {
          thumb.classList.add("border-yellow-500");
          thumb.classList.remove("border-transparent");
        } else {
          thumb.classList.remove("border-yellow-500");
          thumb.classList.add("border-transparent");
        }
      });
    }

    function showTab(tab) {
  const tabs = ["description", "howToUse", "reviews"];  
  const tabButtons = ["descTab", "howToTab", "revTab"]; 
  
  tabs.forEach(t => {
    const element = document.getElementById(t);
    if (element) {
      element.classList.add("hidden");
    }
  });
  
  tabButtons.forEach(b => {
    const element = document.getElementById(b);
    if (element) {
      element.classList.remove("border-b-2", "border-gray-800");
      element.classList.add("text-gray-500");
    }
  });
  
  const tabElement = document.getElementById(tab);
  const tabButtonElement = document.getElementById(tab + "Tab");
  
  if (tabElement) {
    tabElement.classList.remove("hidden");
  }
  if (tabButtonElement) {
    tabButtonElement.classList.add("border-b-2", "border-gray-800");
    tabButtonElement.classList.remove("text-gray-500");
  }
}

    function incrementQuantity() {
      const input = document.getElementById("quantity");
      input.value = parseInt(input.value) + 1;
    }
    
    function decrementQuantity() {
      const input = document.getElementById("quantity");
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
      }
    }

    document.querySelectorAll(".star-rating").forEach(star => {
      star.addEventListener("click", function() {
        const rating = this.dataset.rating;
        document.getElementById("rating").value = rating;

        document.querySelectorAll(".star-rating").forEach((s, index) => {
          if (index < rating) {
            s.classList.remove("far");
            s.classList.add("fas");
          } else {
            s.classList.remove("fas");
            s.classList.add("far");
          }
        });
      });
      
      star.addEventListener("mouseover", function() {
        const rating = this.dataset.rating;
        
        document.querySelectorAll(".star-rating").forEach((s, index) => {
          if (index < rating) {
            s.classList.remove("far");
            s.classList.add("fas");
          } else {
            s.classList.remove("fas");
            s.classList.add("far");
          }
        });
      });
    });

    const starContainer = document.querySelector(".star-rating").parentElement;
    starContainer.addEventListener("mouseleave", function() {
      const currentRating = document.getElementById("rating").value;
      
      document.querySelectorAll(".star-rating").forEach((s, index) => {
        if (index < currentRating) {
          s.classList.remove("far");
          s.classList.add("fas");
        } else {
          s.classList.remove("fas");
          s.classList.add("far");
        }
      });
    });

  
    function toggleWishlist(productId) {
      const icon = document.getElementById("wishlistIcon");
      
      if (icon.classList.contains("far")) {
        icon.classList.remove("far");
        icon.classList.add("fas");
  
      } else {
        icon.classList.remove("fas");
        icon.classList.add("far");
       
      }
    }


    function buyNow(productId) {
      const quantity = document.getElementById("quantity").value;
      window.location.href = `/checkout?productId=${productId}&quantity=${quantity}`;
    }

    function setupImageMagnifier() {
  const mainImage = document.getElementById("mainImage");
  const mainImageContainer = mainImage.parentElement;

  const zoomOverlay = document.createElement("div");
  zoomOverlay.classList.add("zoom-overlay");
  zoomOverlay.style.position = "absolute";
  zoomOverlay.style.top = "0";
  zoomOverlay.style.left = "0";
  zoomOverlay.style.width = "100%";
  zoomOverlay.style.height = "100%";
  zoomOverlay.style.backgroundColor = "#FFFFFF";
  zoomOverlay.style.opacity = "0";
  zoomOverlay.style.transition = "opacity 0.3s ease";
  zoomOverlay.style.pointerEvents = "none";
  zoomOverlay.style.zIndex = "5";
  zoomOverlay.style.display = "none";

  const zoomedImage = document.createElement("img");
  zoomedImage.src = mainImage.src;
  zoomedImage.classList.add("zoomed-image-inner");
  zoomedImage.style.position = "absolute";
  zoomedImage.style.top = "0";
  zoomedImage.style.left = "0";
  zoomedImage.style.width = "200%"; 
  zoomedImage.style.height = "200%"; 
  zoomedImage.style.objectFit = "cover";
  zoomedImage.style.opacity = "0";
  zoomedImage.style.transition = "opacity 0.3s ease";
  zoomedImage.style.pointerEvents = "none";
  zoomedImage.style.zIndex = "6";
  zoomedImage.style.display = "none";
  

  mainImageContainer.appendChild(zoomOverlay);
  mainImageContainer.appendChild(zoomedImage);
 
  mainImage.style.cursor = "crosshair";
  
  function handleThumbnailClick() {
    const thumbnails = document.querySelectorAll(".flex.justify-center.mt-4.space-x-4 img");
    thumbnails.forEach(thumb => {
      thumb.addEventListener("click", function() {
        zoomedImage.src = this.src;
      });
    });
  }
  
  handleThumbnailClick();
  
  
  mainImage.addEventListener("mouseenter", function() {
    zoomOverlay.style.display = "block";
    zoomedImage.style.display = "block";
    setTimeout(() => {
      zoomOverlay.style.opacity = "0.1";
      zoomedImage.style.opacity = "1";
    }, 50);
  });
  
  mainImage.addEventListener("mousemove", function(e) {
    const rect = mainImageContainer.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width;
    const y = (e.clientY - rect.top) / rect.height;
    
 
    const posX = -x * (zoomedImage.offsetWidth - mainImageContainer.offsetWidth);
    const posY = -y * (zoomedImage.offsetHeight - mainImageContainer.offsetHeight);
    
    zoomedImage.style.transform = `translate(${posX}px, ${posY}px)`;
  });
  
  mainImage.addEventListener("mouseleave", function() {
    zoomOverlay.style.opacity = "0";
    zoomedImage.style.opacity = "0";
    setTimeout(() => {
      zoomOverlay.style.display = "none";
      zoomedImage.style.display = "none";
    }, 300);
  });

  let isTouching = false;
  
  mainImage.addEventListener("touchstart", function(e) {
    e.preventDefault();
    isTouching = true;
    zoomOverlay.style.display = "block";
    zoomedImage.style.display = "block";
    setTimeout(() => {
      zoomOverlay.style.opacity = "0.1";
      zoomedImage.style.opacity = "1";
    }, 50);
    
    const touch = e.touches[0];
    const rect = mainImageContainer.getBoundingClientRect();
    const x = (touch.clientX - rect.left) / rect.width;
    const y = (touch.clientY - rect.top) / rect.height;
    
    const posX = -x * (zoomedImage.offsetWidth - mainImageContainer.offsetWidth);
    const posY = -y * (zoomedImage.offsetHeight - mainImageContainer.offsetHeight);
    
    zoomedImage.style.transform = `translate(${posX}px, ${posY}px)`;
  });
  
  mainImage.addEventListener("touchmove", function(e) {
    if (isTouching) {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = mainImageContainer.getBoundingClientRect();
      const x = (touch.clientX - rect.left) / rect.width;
      const y = (touch.clientY - rect.top) / rect.height;
      
      const posX = -x * (zoomedImage.offsetWidth - mainImageContainer.offsetWidth);
      const posY = -y * (zoomedImage.offsetHeight - mainImageContainer.offsetHeight);
      
      zoomedImage.style.transform = `translate(${posX}px, ${posY}px)`;
    }
  });
  
  mainImage.addEventListener("touchend", function() {
    isTouching = false;
    zoomOverlay.style.opacity = "0";
    zoomedImage.style.opacity = "0";
    setTimeout(() => {
      zoomOverlay.style.display = "none";
      zoomedImage.style.display = "none";
    }, 300);
  });
  
  function handleResize() {
    zoomedImage.style.width = mainImageContainer.offsetWidth * 2 + "px";
    zoomedImage.style.height = mainImageContainer.offsetHeight * 2 + "px";
  }
  
  handleResize();
  window.addEventListener("resize", handleResize);
}

document.addEventListener("DOMContentLoaded", function() {
  setupImageMagnifier();
});



document.addEventListener("DOMContentLoaded", function() {
    const cartForm = document.getElementById("cartForm");

    if (cartForm) {
      cartForm.addEventListener("submit", function(e) {
        e.preventDefault();

        const productId = this.querySelector('input[name="productId"]').value;
        const quantity = this.querySelector('input[name="quantity"]').value;

        fetch('/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ productId, quantity: parseInt(quantity) })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success notification
            showNotification('Product added to cart successfully!', 'success');

            // Update cart count in header
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
              cartCountElement.textContent = data.cartCount;
            }
          } else {
            showNotification(data.message || 'Failed to add product to cart', 'error');
            if (data.redirectUrl) {
              setTimeout(() => window.location.href = data.redirectUrl, 2000);
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('An error occurred. Please try again.', 'error');
        });
      });
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.transform = 'translateX(100%)';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);

      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function incrementQuantity() {
      const input = document.getElementById("quantity");
      input.value = parseInt(input.value) + 1;
    }
    
    function decrementQuantity() {
      const input = document.getElementById("quantity");
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
      }
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    const sizeButtons = document.querySelectorAll('.size-btn');
    const variantIndexInput = document.getElementById('variantIndex');
    const cartForm = document.getElementById('cartForm');
    const sizeError = document.getElementById('size-error');

    sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (!this.disabled) {
                sizeButtons.forEach(btn => btn.classList.remove('active', 'border-gray-800'));
                this.classList.add('active', 'border-gray-800');
                variantIndexInput.value = this.dataset.variantIndex;
                sizeError.classList.add('hidden');
            }
        });
    });

    cartForm.addEventListener("submit", function(e) {
        e.preventDefault();

        if (!variantIndexInput.value) {
            sizeError.classList.remove('hidden');
            return;
        }

        const productId = this.querySelector('input[name="productId"]').value;
        const quantity = this.querySelector('input[name="quantity"]').value;
        const variantIndex = variantIndexInput.value;

        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId, quantity: parseInt(quantity), variantIndex: parseInt(variantIndex) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Product added to cart successfully!', 'success');
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement) {
                    cartCountElement.textContent = data.cartCount;
                }
            } else {
                showNotification(data.message || 'Failed to add product to cart', 'error');
                if (data.redirectUrl) {
                    setTimeout(() => window.location.href = data.redirectUrl, 2000);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred. Please try again.', 'error');
        });
    });
});
  </script>
</body>
</html>